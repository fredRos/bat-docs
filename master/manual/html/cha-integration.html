<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <!-- For Mobile Devices -->
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
        <meta name="generator" content="Doxygen 1.8.11"/>
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
        <title>BAT manual: Integration</title>
        <!--<link href="tabs.css" rel="stylesheet" type="text/css"/>-->
        <script type="text/javascript" src="dynsections.js"></script>
        <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
        <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
MathJax.Hub.Config({
    TeX: {
        Macros: {
            cond: ["{\\,|\\,}"],
            rmdx: ["{\\mbox{d}#1\\,}",1],
            scath: ["{\\theta}"],
            vecth: ["{\\boldsymbol{\\theta}}"],
            order: ["{\\mathcal{O}(#1)}",1],
        }
    }
});
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/latest.js?config=TeX-MML-AM_CHTML/MathJax.js"></script>
        <link href="doxygen.css" rel="stylesheet" type="text/css" />
        <link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
        <link href='https://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="doxy-boot.js"></script>
    </head>
    <body>
        <nav class="navbar navbar-default" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand">BAT manual 1.0.0-RC2</a>
                </div>
            </div>
        </nav>
        <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
            <div class="content" id="content">
                <div class="container">
                    <div class="row">
                        <div class="col-sm-12 panel " style="padding-bottom: 15px;">
                            <div style="margin-bottom: 15px;">
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Overview</span></a></li>
      <li class="current"><a href="pages.html"><span>Chapters</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Integration </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#sec-int-motiv">Motivation</a></li>
<li class="level1"><a href="#sec-int-marg">Marginalization</a></li>
<li class="level1"><a href="#sec-int-evidence">Evidence</a><ul><li class="level2"><a href="#sec-int-rescale">Rescaling</a></li>
<li class="level2"><a href="#sec-int-cuba">Cuba</a></li>
</ul>
</li>
<li class="level1"><a href="#sec-int-slice">Slices</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="sec-int-motiv"></a>
Motivation</h1>
<p>The reason that BAT exists is that nearly any Bayesian analysis these days is too complicated to be handled analytically. To address typical questions like</p>
<ul>
<li>What is known about a single parameter taking into account the uncertainty on all other parameters?</li>
<li>How are parameters correlated?</li>
</ul>
<p>one needs to be able to compute and visualize 1D and 2D <em>marginal distributions</em>; cf. <a class="el" href="cha-Bayes.html#sec-marginalization">Marginalization</a>. These are defined as integrals over the posterior; for example the 2D marginal distribution is </p><p class="formulaDsp">
\begin{align} \label{eq:int-marginal} P(\theta_1, \theta_2 \cond D) = \int \prod_{i \ne 1,2} \rmdx{\theta_i} P(\vecth \cond D). \end{align}
</p>
<p> To do model comparison, one has to compute the evidence, that is the integral over all parameters </p><p class="formulaDsp">
\begin{equation} Z = \int \rmdx{ \vecth} P(D|\vecth, M) P(\vecth \cond M). \end{equation}
</p>
<p> Therefore Bayesian inference in practice requires good integration techniques. These methods are bundled in the class <code><a class="elRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCIntegrate.html">BCIntegrate</a></code> with the exception of the Markov chain code in <code><a class="elRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCEngineMCMC.html">BCEngineMCMC</a></code>; see also the <a class="el" href="cha-code-structure.html">Structure of the Code</a>.</p>
<p>For low-dimensional problems, deterministic integration methods are usually the fastest and most robust but for higher dimensions, Monte Carlo techniques are the most efficient tools known. Depending on the setting, BAT defaults to deterministic methods for \(d \le 2,3\) dimensions and uses Monte Carlo for \(d&gt;3\).</p>
<h1><a class="anchor" id="sec-int-marg"></a>
Marginalization</h1>
<p>The main use case for BAT is to estimate and visualize the marginal distributions of the posterior. Given a model <code>m</code>, all marginal distributions are estimated as histograms by</p>
<div class="fragment"><div class="line">m.MarginalizeAll();</div></div><!-- fragment --><p>The individual distributions can be accessed using</p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000004">Todo:</a></b></dt><dd><p class="startdd">snippet of 1D, par 2 vs 5 </p>
<p class="enddd">show how to constrain which distributions are stored, useful if many nuisance parameters.</p>
</dd></dl>
<p>The method for marginalizing can be selected as follows</p>
<div class="fragment"><div class="line">m.SetMarginalizationMethod(method);</div></div><!-- fragment --><p>where <code>method</code> is an <code>enum</code> in <code><a class="elRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCIntegrate.html#ab764d9b6ae3cc8b5c15b3f61a164c83c">BCIntegrate::BCMarginalizationMethod</a></code></p>
<table class="doxtable">
<tr>
<th><code>method</code> </th><th>Details  </th></tr>
<tr>
<td><code>kMargMetropolis</code> </td><td>Metropolis algorithm; see <a class="el" href="cha-mcmc.html">Markov chain Monte Carlo</a>. </td></tr>
<tr>
<td><code>kMargMonteCarlo</code> </td><td>Sample mean integration in each histogram bin. Least efficient method. </td></tr>
<tr>
<td><code>kMargGrid</code> </td><td>Evaluate target at each bin center. Most efficient for 1D and 2D. </td></tr>
<tr>
<td><code>kMargDefault</code> </td><td>Use <code>kMargGrid</code> for \(d \leq 2 \), else <code>kMargMetropolis</code>. </td></tr>
</table>
<p>The availability of marginalization methods can be queried at runtime using <code><a class="elRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCIntegrate.html#a91640a13ea40dab50609bf6c6fa41555">BCIntegrate::CheckMarginalizationAvailability</a></code>.</p>
<p>In case any pre- or postprocessing needs to happen to set up data structures, we provide the hooks <code>virtual void <a class="elRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCIntegrate.html#ab3168ad69c437f2ce701f80f3fb31779">BCIntegrate::MarginalizePreprocess</a></code> and <code>virtual void <a class="elRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCIntegrate.html#adbcbbe4a9e22b2789733173ea42b8b29">BCIntegrate::MarginalizePostprocess</a></code>. They are empty by default and can be overloaded in a user model.</p>
<h1><a class="anchor" id="sec-int-evidence"></a>
Evidence</h1>
<p>In BAT terminology, the evidence or normalization constant of a model <code>m</code> with the default method is computed as</p>
<div class="fragment"><div class="line"><span class="keywordtype">double</span> evidence = m.Normalize();</div></div><!-- fragment --><p>This is the evidence on the linear scale. Choose the method of integration explicitly with</p>
<div class="fragment"><div class="line"><span class="keywordtype">double</span> evidence = m.Integrate(method);</div></div><!-- fragment --><p>where <code>method</code> is an <code>enum</code> in <code><a class="elRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCIntegrate.html#a52f58ec64535f489dbbd845940ef71e7">BCIntegrate::BCIntegrationMethod</a></code>.</p>
<table class="doxtable">
<tr>
<th><code>BCIntegrationMethod</code> </th><th>Details  </th></tr>
<tr>
<td><code>kIntMonteCarlo</code> </td><td>Sample mean. Usually least efficient. </td></tr>
<tr>
<td><code>kIntCuba</code> </td><td>Use a method from cuba. </td></tr>
<tr>
<td><code>kIntGrid</code> </td><td>Approximate Riemann sum over a dense grid for \(d \leq 3 \). </td></tr>
<tr>
<td><code>kIntLaplace</code> </td><td>Laplace approxation. Only approximately valid for peaked unimodal integrands. Incorrect if distribution is heavy tailed or if the mode is near a boundary. Very fast. No uncertainty estimate. Only method implemented on the log scale. </td></tr>
<tr>
<td><code>kIntDefault</code> </td><td>Use Cuba if available. Else use <code>kIntGrid</code> for \(d \leq 3 \) and <code>kIntMonteCarlo</code> for \(d &gt; 3 \). </td></tr>
</table>
<p>General termination criteria for all integration methods except <code>kIntLaplace</code> are the desired absolute precision \(\epsilon_a\) and relative precision \(\epsilon_r\) and the minimum and maximum number of iterations:</p>
<div class="fragment"><div class="line">m.SetAbsolutePrecision(1e-6);</div><div class="line">m.SetRelativePrecision(1e-8);</div><div class="line">m.SetNIterationsMin(2000);</div><div class="line">m.SetNIterationsMax(50000);</div></div><!-- fragment --><p>The integration terminates if </p><p class="formulaDsp">
\begin{equation} |Z-\hat{Z}| \leq \max(\epsilon_a, \epsilon_r Z) \end{equation}
</p>
<p> where \(\hat{Z}\) is the current estimate of the evidence.</p>
<h2><a class="anchor" id="sec-int-rescale"></a>
Rescaling</h2>
<p>In case the log likelihood is very small or very large, going to the linear scale may take it to exactly zero or infinity in finite precision. This often happens in practice if the log likelihood is a sum of <code>N</code> terms. For example, assume each factor is 0.5. Then \(\exp(0.5 N)=\infty\) on the computer for \(N \geq 1420\) using double precision. To avoid this problem, you can rescale the log likelihood by manually subtracting the value at the mode inside <code>LogLikelihood</code>.</p>
<p>Another option, if requirements are satisfied, is to use the Laplace method. It is naturally implemented on the log scale. While the standard interface to all integration methods via <code><a class="elRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCIntegrate.html#a25a1c24ea3ec1f2d491309100f0eb5b6">BCIntegrate::Normalize()</a></code> always transforms to the linear scale, calling <code><a class="elRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCIntegrate.html#a86343b194b311701d961deef1f1c388c">BCIntegrate::IntegrateLaplace()</a></code> directly returns the evidence on the log scale.</p>
<h2><a class="anchor" id="sec-int-cuba"></a>
Cuba</h2>
<p>The Cuba package itself has four different integration methods. Cuba is an external dependency; see the installation instructions on how to build BAT with Cuba support. If Cuba is available, select the Cuba method with </p><div class="fragment"><div class="line">m.SetCubaIntegrationMethod(method);</div><div class="line">m.Integrate();</div><div class="line"><span class="comment">// alternative</span></div><div class="line">m.IntegrateCuba(method);</div></div><!-- fragment --><p> where <code>method</code> is an <code>enum</code> in <code><a class="elRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCIntegrate.html#a22aaa96f03795afa833f9381ba5b117f">BCIntegrate::BCCubaMethod</a></code></p>
<table class="doxtable">
<tr>
<th><code>BCCubaMethod</code> </th><th>Details  </th></tr>
<tr>
<td><code>kCubaVegas</code> </td><td>VEGAS algorithm by Lepage </td></tr>
<tr>
<td><code>kCubaSuave</code> </td><td>Suave algorithm. </td></tr>
<tr>
<td><code>kCubaDivonne</code> </td><td>Divonne algorithm. </td></tr>
<tr>
<td><code>kCubaCuhre</code> </td><td>Cuhre algorithm. Essentially quadrature in higher dimensions. Suffers from curse of dimensionality but most efficient and robust in low dimensions. </td></tr>
<tr>
<td><code>kCubaDefault</code> </td><td>For \(d=1\), use VEGAS, for \(d=2,3\), use Cuhre, and for \(d&gt; 3\), use Divonne. </td></tr>
</table>
<p>Each Cuba method comes with various parameter values to set. We have taken over default values from the example that comes with Cuba but they are by no means optimal for every problem. Please experiment and consult the Cuba manual that comes with the Cuba source code from <a href="http://www.feynarts.de/cuba/">http://www.feynarts.de/cuba/</a>. All options are accessible in the namespace <code><a class="elRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/structBCCubaOptions_1_1Cuhre.html">BCCubaOptions</a></code>. An example with bogus values</p>
<div class="fragment"><div class="line"><a class="codeRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/structBCCubaOptions_1_1Suave.html">BCCubaOptions::Suave</a> o = m.GetCubaSuaveOptions();</div><div class="line">o.flatness = 5;</div><div class="line">o.nnew = 5000;</div><div class="line">o.nmin = 15;</div><div class="line">m.SetNIterationsMax(1e7);</div><div class="line">m.SetCubaOptions(o);</div><div class="line">m.IntegrateCuba(<a class="codeRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCIntegrate.html#a22aaa96f03795afa833f9381ba5b117fa365ff239cce8f13ea0e68bd0d828e58b">BCIntegrate::kCubaSuave</a>);</div></div><!-- fragment --><h1><a class="anchor" id="sec-int-slice"></a>
Slices</h1>
<p>To get a quick visualization of a complicated posterior, a slice, or projection, may be preferable to a full marginalization. That is, all parameters except one [two] are held fixed (instead of integrated over as in marginalization) and the remaining parameter[s] are evaluated on a regular grid. In other words, the conditional distribution</p>
<p class="formulaDsp">
\begin{equation} P(\theta_1 \cond \vecth_{\backslash 1}, D) = \frac{P(\vecth \cond D)} {P(\vecth_{\backslash 1} \cond D)} . \end{equation}
</p>
<p>The slice is returned as one [two] dimensional histogram. This is achieved with the various variants of <code><a class="elRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCIntegrate.html#a074c323e50f6daec794c526c6b90231d">BCIntegrate::GetSlice</a></code>.</p>
<p>In a posterior where all parameters are independent, the marginal and conditional distributions coincide because</p>
<p class="formulaDsp">
\begin{equation} P(\theta_1 \cond \vecth_{\backslash 1}, D) = \frac{P(\vecth_{\backslash 1} \cond D) P(\theta_1 \cond D)} {P(\vecth_{\backslash 1} \cond D)}= P(\theta_1 \cond D) . \end{equation}
</p>
<dl class="section note"><dt>Note</dt><dd>Independence rarely holds in practice, so marginalization is still useful.</dd></dl>
<p>For example, in a Gaussian posterior with independent parameters, we first find the mode and use these parameter values to find the 1D conditional distribution of the first parameter. In this example, the result is just a Gaussian. Here is how to find the result in general, for non-Gaussian or non-independent posteriors: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;TH1.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;TCanvas.h&gt;</span></div><div class="line">...</div><div class="line">int main()</div><div class="line">{</div><div class="line">...</div><div class="line">    m.FindMode(m.GetBestFitParameters());</div><div class="line"></div><div class="line">    TCanvas c;</div><div class="line">    <span class="keywordtype">unsigned</span> nIterations;</div><div class="line">    <span class="keywordtype">double</span> log_max;</div><div class="line">    <span class="keywordtype">int</span> nbins = 100;</div><div class="line">    <span class="keywordtype">bool</span> normalize = <span class="keyword">true</span>;</div><div class="line">    TH1* slice = m.GetSlice(0, nIterations, log_max, m.GetBestFitParameters(), nbins, normalize);</div><div class="line">    slice-&gt;Draw(<span class="stringliteral">&quot;HISTSAME&quot;</span>);</div><div class="line">    c.Print(<span class="stringliteral">&quot;slice.pdf&quot;</span>);</div><div class="line">    <span class="keyword">delete</span> slice;</div><div class="line">...</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
</div>
</div>
</div>
</div>
</div>
<!-- <hr class="footer"/><address class="footer"><small> -->
<!-- Generated on Tue May 8 2018 13:18:41 for BAT manual by &#160;<a href="http://www.doxygen.org/index.html"> -->
<!-- <img class="footer" src="doxygen.png" alt="doxygen"/> -->
<!-- </a> 1.8.11 -->
<!-- </small></address> -->
</body>
</html>
