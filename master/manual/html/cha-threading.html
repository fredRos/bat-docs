<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <!-- For Mobile Devices -->
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
        <meta name="generator" content="Doxygen 1.8.11"/>
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
        <title>BAT manual: Multithreading and Thread Safety</title>
        <!--<link href="tabs.css" rel="stylesheet" type="text/css"/>-->
        <script type="text/javascript" src="dynsections.js"></script>
        <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
        <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
MathJax.Hub.Config({
    TeX: {
        Macros: {
            cond: ["{\\,|\\,}"],
            rmdx: ["{\\mbox{d}#1\\,}",1],
            scath: ["{\\theta}"],
            vecth: ["{\\boldsymbol{\\theta}}"],
            order: ["{\\mathcal{O}(#1)}",1],
        }
    }
});
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/latest.js?config=TeX-MML-AM_CHTML/MathJax.js"></script>
        <link href="doxygen.css" rel="stylesheet" type="text/css" />
        <link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
        <link href='https://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="doxy-boot.js"></script>
    </head>
    <body>
        <nav class="navbar navbar-default" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand">BAT manual 1.0.0-RC2</a>
                </div>
            </div>
        </nav>
        <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
            <div class="content" id="content">
                <div class="container">
                    <div class="row">
                        <div class="col-sm-12 panel " style="padding-bottom: 15px;">
                            <div style="margin-bottom: 15px;">
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Overview</span></a></li>
      <li class="current"><a href="pages.html"><span>Chapters</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Multithreading and Thread Safety </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In a demanding analysis, a single evaluation of the posterior may take seconds or more. In an MCMC analysis, this is then the bottle neck. The overall time to solution can then be reduced by running multiple chains on multiple threads.</p>
<p>Assuming BAT is configured with parallelization enabled (see the <a class="el" href="cha-install.html">Installation instructions</a>), the number of threads can be selected at runtime without recompilation with <code>./program OMP_NUM_THREADS=N</code>. Due to the overhead from thread creation, the sampling is faster only if the likelihood is sufficiently slow to compute. As a rule of thumb, if the unparallelized sampling takes minutes or even hours, the parallelized version should get close to the maximum speedup given by the number of cores. For very simple likelihoods (say one millisecond per evaluation), the overhead from synchronizing threads usually slows down the entire process. We invite the user to experiment which number of threads gives the best performance.</p>
<p>If BAT is compiled with support for threads and the number of threads is not set explicitly, it is implementation dependent whether only one thread is created or as many as there are available cores. To enforce serial execution, simply set <code>OMP_NUM_THREADS=1</code>.</p>
<p>For guidance, tests showed that it is beneficial to have as many threads as your computer provides. Working on a quad core machine with hyper-threading, we observed a speedup factor of 3.5 &ndash; 3.9 with 8 and 16 chains on 8 cores for a likelihood that takes more than a second to evaluate.</p>
<dl class="section warning"><dt>Warning</dt><dd>The results of the sampling become nonsense if multiple threads are used but the likelihood itself is not thread safe.</dd></dl>
<p>A simple example of a non-thread-safe likelihood is </p><div class="fragment"><div class="line"><span class="keywordtype">double</span> MyModel::LogLikelihood(<span class="keyword">const</span> std::vector&lt;double&gt;&amp; parameters)</div><div class="line">{</div><div class="line">  <span class="comment">// assign member variable</span></div><div class="line">  this-&gt;member = parameters[0];</div><div class="line"></div><div class="line">  <span class="comment">// value of member used in MyModel::Method</span></div><div class="line">  <span class="keywordflow">return</span> this-&gt;Method();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">double</span> MyModel::Method()</div><div class="line">{</div><div class="line">  <span class="keywordflow">return</span> -member * member;</div><div class="line">}</div></div><!-- fragment --><p>If the method <code>MyModel::Method</code> is called simultaneously from different threads with different <code>parameters</code>, its return value depends on the arbitrary call order of individual threads. There is a race condition on <code>member</code> because it is read and written simultaneously by multiple threads so the result of <code>LogLikelihood</code> is not deterministic. There are several solutions.</p>
<h2>Avoid state</h2>
<p>In this contrived example, it is easiest to avoid using any member variable or method call and do everything inside <code>LogLikelihood</code> </p><div class="fragment"><div class="line"><span class="keywordtype">double</span> MyModel::LogLikelihood(<span class="keyword">const</span> std::vector&lt;double&gt;&amp; parameters)</div><div class="line">{</div><div class="line">  <span class="keywordflow">return</span> -parameter[0] * parameter[0];</div><div class="line">}</div></div><!-- fragment --><h2>Independent copies of state</h2>
<p>In practice, it may be impractical or even inevitable to maintain state and call into other functions that require state. A clean solution is to move <code>Method</code> into <code>OtherClass</code>, and to keep an independent copy of <code>OtherClass</code> for each thread or each chain. For this purpose, we provide the hook <code><a class="elRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCEngineMCMC.html#a4b5836bbd37aed17edde8fd9c4475a8b">BCEngineMCMC::MCMCUserInitialize</a></code> that is called before any chain attempts to evaluate the likelihood. For example:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>SomeState</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  <span class="keywordtype">double</span> Method() { ... }</div><div class="line"><span class="keyword">private</span>:</div><div class="line">  <span class="keywordtype">double</span> t;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">class </span>MyModel</div><div class="line">{</div><div class="line"><span class="keyword">public</span>:</div><div class="line">  ...</div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">void</span> MCMCUserInitialize()</div><div class="line">  {</div><div class="line">    state.resize(GetNChains());</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">virtual</span> <span class="keywordtype">double</span> LogLikelihood(<span class="keyword">const</span> std::vector&lt;double&gt;&amp; parameters)</div><div class="line">  {</div><div class="line">    SomeState&amp; s = state.at(GetCurrentChain());</div><div class="line">    s.t = parameters[0];</div><div class="line">    <span class="keywordflow">return</span> s.Method();</div><div class="line">  }</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">  std::vector&lt;SomeState&gt; state;</div><div class="line">};</div></div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>In BAT, only the Markov chain sampling uses multiple threads. During optimization or any algorithm, only one thread is active. In the above example, <code><a class="elRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCEngineMCMC.html#ad2708eb7609d9f0e70de76f379a6dde6">BCEngineMCMC::GetCurrentChain</a></code> returns 0 in such a context. </dd></dl>
</div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
</div>
</div>
</div>
</div>
</div>
<!-- <hr class="footer"/><address class="footer"><small> -->
<!-- Generated on Tue May 8 2018 13:18:41 for BAT manual by &#160;<a href="http://www.doxygen.org/index.html"> -->
<!-- <img class="footer" src="doxygen.png" alt="doxygen"/> -->
<!-- </a> 1.8.11 -->
<!-- </small></address> -->
</body>
</html>
