<!-- HTML header for doxygen 1.8.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <!-- For Mobile Devices -->
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
        <meta name="generator" content="Doxygen 1.8.11"/>
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
        <title>BAT manual: Multi-template fitter</title>
        <!--<link href="tabs.css" rel="stylesheet" type="text/css"/>-->
        <script type="text/javascript" src="dynsections.js"></script>
        <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
        <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
MathJax.Hub.Config({
    TeX: {
        Macros: {
            cond: ["{\\,|\\,}"],
            rmdx: ["{\\mbox{d}#1\\,}",1],
            scath: ["{\\theta}"],
            vecth: ["{\\boldsymbol{\\theta}}"],
            order: ["{\\mathcal{O}(#1)}",1],
        }
    }
});
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/latest.js?config=TeX-MML-AM_CHTML/MathJax.js"></script>
        <link href="doxygen.css" rel="stylesheet" type="text/css" />
        <link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
        <link href='https://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="doxy-boot.js"></script>
    </head>
    <body>
        <nav class="navbar navbar-default" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand">BAT manual 1.0.0-RC2</a>
                </div>
            </div>
        </nav>
        <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
            <div class="content" id="content">
                <div class="container">
                    <div class="row">
                        <div class="col-sm-12 panel " style="padding-bottom: 15px;">
                            <div style="margin-bottom: 15px;">
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Overview</span></a></li>
      <li class="current"><a href="pages.html"><span>Chapters</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Multi-template fitter </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#sec-mtf-math">Mathematical formulation</a><ul><li class="level2"><a href="#sec-mtf-exclsyst">Excluding systematic uncertainies</a></li>
<li class="level2"><a href="#sec-mtf-inclsyst">Including Systematic Uncertainies</a></li>
</ul>
</li>
<li class="level1"><a href="#sec-mtf-basics">Creating the Fitter</a></li>
<li class="level1"><a href="#sec-mtf-addchannel">Adding a Channel</a></li>
<li class="level1"><a href="#sec-mtf-adddata">Adding a Data Set</a></li>
<li class="level1"><a href="#sec-mtf-addprocess">Adding a Process</a></li>
<li class="level1"><a href="#sec-mtf-addunc">Adding Systematic Uncertainties</a></li>
<li class="level1"><a href="#sec-mtf-runfit">Running the Fit</a></li>
<li class="level1"><a href="#sec-mtf-mtfoutput">Output</a></li>
<li class="level1"><a href="#sec-mtf-mtfsettings">Settings</a></li>
<li class="level1"><a href="#sec-mtf-facility">Analysis Facility</a></li>
<li class="level1"><a href="#sec-mtf-perf_ensemble">Performing Ensemble Tests</a></li>
<li class="level1"><a href="#sec-mtf-create_ensem">Creating Ensembles</a></li>
<li class="level1"><a href="#sec-mtf-analyze_ensem">Analyzing Ensembles</a></li>
<li class="level1"><a href="#sec-mtf-autom_analyses">Performing Automated Analyses</a><ul><li class="level2"><a href="#sec-mtf-perf_single_channel">Performing Single-Channel Analyses</a></li>
<li class="level2"><a href="#sec-mtf-perf_single_channel_syst">Performing Single Systematic Analyses</a></li>
<li class="level2"><a href="#sec-mtf-perf_calib">Performing Calibration Analyses</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><dl class="todo"><dt><b><a class="el" href="todo.html#_todo000017">Todo:</a></b></dt><dd>let kevin check if info up to date, this is just copied from introduction.tex</dd></dl>
<p>the multi-template fitter (mtf) is a tool which allows to fit several template histograms to a data histogram. the content of the bins in the templates are assumed to fluctuate independently according to poisson distributions. several channels can be fitted simultaneously.</p>
<h1><a class="anchor" id="sec-mtf-math"></a>
Mathematical formulation</h1>
<p>the multi-template fitter is formulated in terms of bayesian reasoning. the posterior probability is proportional to the product of the likelihood and the prior probability. the latter can be freely chosen by the user whereas the likelihood is predefined. it is a binned likelihood which assumes that the fluctuations in each bin are of poisson nature and independent of each other. all channels, processes and sources of systematic uncertainties are assumed to be uncorrelated.</p>
<p>the parameters of the model are thus the expectation values of the different processes, \(\lambda_{k}\), and the nuisance parameters, \(\delta_{l}\).</p>
<h2><a class="anchor" id="sec-mtf-exclsyst"></a>
Excluding systematic uncertainies</h2>
<p>in case no sources of systematic uncertainty are taken into account the likelihood is defined as </p><p class="formulaDsp">
\begin{eqnarray} l = \prod_{i=1}^{n_{\mathrm{ch}}} \prod_{j=1}^{n_{\mathrm{bin}}} \frac{\lambda_{ij}^{n_{ij}}}{n_{ij}!} e^{-\lambda_{ij}} \, , \label{eqn:likelihood} \end{eqnarray}
</p>
<p> where \(n_{\mathrm{ch}}\) and \(n_{\mathrm{bin}}\) are the number of channels and bins, respectively. \(n_{ij}\) and \(\lambda_{ij}\) are the observed and expected number of events in the \(j\)th bin of the \(i\)th channel. The expected number of events are calculated via </p><p class="formulaDsp">
\begin{eqnarray} \lambda_{ij} &amp; = &amp; \sum_{k=1}^{N_{\mathrm{p}}} \lambda_{ijk} \\ &amp; = &amp; \sum_{k=1}^{N_{\mathrm{p}}} \lambda_{k} \cdot f_{ijk} \cdot \epsilon_{ik} \, , \label{eqn:expectation} \end{eqnarray}
</p>
<p> where \(f_{ij}\) is the bin content of the \(j\)th bin in the normalized template of the \(k\)th process in the \(i\)th channel. \(\epsilon_{ik}\) is the efficiency of the \(k\)th process in the \(i\)th channel specified when setting the template. \(\lambda_{k}\) is the contribution of the \(k\)th process and is a free parameter of the fit.</p>
<h2><a class="anchor" id="sec-mtf-inclsyst"></a>
Including Systematic Uncertainies</h2>
<p>In case sources of systematic uncertainties are taken into account, the efficiency \(\epsilon_{ik}\) is modified according to a nuisance parameter: </p><p class="formulaDsp">
\begin{eqnarray} \epsilon_{ik} \rightarrow \epsilon_{ik} \cdot (1 + \sum_{l=1}^{N_{\mathrm{syst}}} \delta_{l}\cdot \Delta\epsilon_{ijkl}) \, , \label{eqn:systematic} \end{eqnarray}
</p>
<p> where \(\delta_{l}\) is the nuisance parameter associated with the source of systematic uncertainty and \(\Delta\epsilon_{ijkl}\) is the change in efficiency due to the \(l\)th source of systematic uncertainty in the \(i\)th channel and \(j\)th bin for the \(k\)th process.</p>
<h1><a class="anchor" id="sec-mtf-basics"></a>
Creating the Fitter</h1>
<p>The main MTF class <code><a class="elRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCMTF.html">BCMTF</a></code> is derived from the <code><a class="elRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCModel.html">BCModel</a></code> class. A new instance can be created via</p>
<div class="fragment"><div class="line"><a class="codeRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCMTF.html#ac917e39178db35eeb2efcd860b2491f0">BCMTF::BCMTF</a>()</div><div class="line"><a class="codeRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCMTF.html">BCMTF</a>::<a class="codeRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCMTF.html">BCMTF</a>(const <span class="keywordtype">char</span> * name)</div></div><!-- fragment --><p>where the name of the MTF can be specified via argument <code>name</code>.</p>
<h1><a class="anchor" id="sec-mtf-addchannel"></a>
Adding a Channel</h1>
<p>The MTF fits several channels simultaneously. These channels can be physics channels, e.g., \(Z^{0}\rightarrow e^{+}e^{-}\) and \(Z^{0}\rightarrow \mu^{+}\mu^{-}\), samples with disjunct jet multiplicity or entirely different classes altogether. A new channel can be added using the following method:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="codeRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCMTF.html#a63cda87ffb4291eebdf19560faba44b6">BCMTF::AddChannel</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * name)</div></div><!-- fragment --><p>where <code>name</code> is the name of the process, and the return value is an error code. Note that at least one channel has to be added.</p>
<h1><a class="anchor" id="sec-mtf-adddata"></a>
Adding a Data Set</h1>
<p>Each channel added to the MTF has a unique data set which comes in form of a (<code>TH1D</code>) histogram. It can be defined using the following method:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="codeRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCMTF.html#a4efb37890b2577e6c9ab963c33685dfd">BCMTF::SetData</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * channelname, TH1D hist)</div></div><!-- fragment --><p>where <code>channelname</code> is the name of the channel and <code>hist</code> is the histogram representing the data. The return value is an error code.</p>
<h1><a class="anchor" id="sec-mtf-addprocess"></a>
Adding a Process</h1>
<p>Each template that is fit to the data set corresponds to a process, where one process can occur in several channels. The fit then defines the contribution of the process and thus each process comes with one model parameter. A process can be added using the following method:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="codeRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCMTF.html#a7752db307762fda7000cee1d097230d6">BCMTF::AddProcess</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * name,</div><div class="line">                      <span class="keywordtype">double</span> nmin = 0.,</div><div class="line">                      <span class="keywordtype">double</span> nmax = 1.) ,</div></div><!-- fragment --><p>where <code>name</code> is the name of the process and <code>nmin</code> and <code>nmax</code> are the lower and upper bound of the parameter associated with the contribution of the process. The parameter is denoted \(\lambda_{k} \, (k=1\dots N_{\mathrm{p}})\) in the <a class="el" href="cha-mtf.html#sec-mtf-math">Mathematical formulation</a>. Note that at least one process has to be added. A prior needs to be defined for each process, using the default <code><a class="elRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCModel.html">BCModel</a></code> methods.</p>
<p>It is likely that a single process will have different shapes in different channels. Thus, templates for a process need to be defined for each channel separately using the following method:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="codeRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCMTF.html#a23e6132995ef0468c6f1c5f986a59c85">BCMTF::SetTemplate</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * channelname,</div><div class="line">                       <span class="keyword">const</span> <span class="keywordtype">char</span> * processname,</div><div class="line">                       TH1D hist,</div><div class="line">                       <span class="keywordtype">double</span> efficiency = 1.) ,</div></div><!-- fragment --><p>where <code>channelname</code> and <code>processname</code> are the names of the channel and the process, respectively. The parameter <code>hist</code> is the (<code>TH1D</code>) histogram (or template) which represents the process. The histogram will be normalized to unity and the entries in the normalized histogram are the probabilities to find an event of a process \(k\) and channel \(i\) in bin \(j\). This probability is denoted \(f_{ijk}\,(i=1\dots N_{\mathrm{ch}}, \, j=1\dots N_{\mathrm{b}}, \, k=1\dots N_{\mathrm{p}})\) in the <a class="el" href="cha-mtf.html#sec-mtf-math">Mathematical formulation</a>. The last parameter, <code>efficiency</code>, is the efficiency of the process in that channel and is used to scale to template during the fit. This is needed if a process contributes with different amounts in two separate channels. The efficiency is denoted \(\epsilon_{ik} \, (i=1\dots N_{\mathrm{ch}}, \, k=1\dots N_{\mathrm{p}})\) in the <a class="el" href="cha-mtf.html#sec-mtf-math">Mathematical formulation</a>. The return value is an error code. Note that templates do not have to be set if the process does not contribute to a particular channel.</p>
<h1><a class="anchor" id="sec-mtf-addunc"></a>
Adding Systematic Uncertainties</h1>
<p>Systematic uncertainties can alter the shape of a template. Sources of systematic uncertainty can be included in the fit using nuisance parameters. This nuisance parameter is assumed to alter the original template linearly, where values of -1, 0, and 1 correspond to the “downwards” shifted, nominal and “upwards shifted” template, respectively. The nuisance parameters are denoted \(\delta_{l} \, (l=1\dots N_{\mathrm{syst}})\) in the <a class="el" href="cha-mtf.html#sec-mtf-math">Mathematical formulation</a>. Shifted refers to a change of one standard deviation. An example for a nuisance parameter could be the jet energy scale (JES). With a nominal JES of 1 and and uncertainty of 5%, the scaled templates correspond to a JES of 0.95 and 1.05, respectively. A prior needs to be defined for each nuisance parameter which is usually chosen to be a standard normal distribution. A source of systematic uncertainty can be added using the following method:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="codeRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCMTF.html#a7effb42518f62702b29f8b44040b83c7">BCMTF::AddSystematic</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * name,</div><div class="line">                         <span class="keywordtype">double</span> min = -5.,</div><div class="line">                         <span class="keywordtype">double</span> max = 5.) ,</div></div><!-- fragment --><p>where <code>name</code> is the name of the source of systematic uncertainty and <code>min</code> and <code>max</code> are the lower and upper bound of the nuisance parameter, respectively. The return value is an error code.</p>
<p>Since the different sources of systematic uncertainty have an individual impact on each process and in each channel, these need to be specified. Two method can be used to define the impact:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="codeRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCMTF.html#a8494b4a26dc22ac367984508831766a1">BCMTF::SetSystematicVariation</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * channelname,</div><div class="line">                                  <span class="keyword">const</span> <span class="keywordtype">char</span> * processname,</div><div class="line">                                  <span class="keyword">const</span> <span class="keywordtype">char</span> * systematicname,</div><div class="line">                                  TH1D hist_up,</div><div class="line">                                  TH1D hist_down) ,</div></div><!-- fragment --><p>where <code>channelname</code>, <code>processname</code> and <code>systematicname</code> are the names of the channel, the process and the source of systematic uncertainty. The (<code>TH1D</code>) histograms <code>hist_up</code> and <code>hist_down</code> are the histograms corresponding to an “up”- and “down”-scaling of the systematic uncertainty of one standard deviation, i.e., for each bin entry \(y\) they are calculated as </p><p class="formulaDsp">
\begin{eqnarray} \label{eqn:deltay} \Delta_{\mathrm{up}} &amp; = &amp; (y_{\mathrm{up}} - y_{\mathrm{nominal}})/y_{\mathrm{nominal}} \, , \\ \Delta_{\mathrm{down}} &amp; = &amp; (y_{\mathrm{nominal}} - y_{\mathrm{down}})/y_{\mathrm{nominal}} \, . \end{eqnarray}
</p>
<p>Note the sign of the down-ward fluctuation. These histograms define the change of the bins in each template in the efficiency which is denoted \(\Delta\epsilon_{ijkl} \, (i=1\dots N_{\mathrm{ch}}, \, j=1\dots N_{\mathrm{b}}, \, k=1\dots N_{\mathrm{p}}, \, l=1\dots N_{\mathrm{syst}})\). For example, if the value for a particular bin of <code>hist_up</code> is 0.05, i.e., if the systematic uncertaintiy is 5% in that bin, then the efficiency of the process in that channel will be multiplied by \((1+0.05)\). The return value is an error code.</p>
<p>The second variant does not take the difference in efficiency, but calculates it internally from the absolute values:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="codeRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCMTF.html#a8494b4a26dc22ac367984508831766a1">BCMTF::SetSystematicVariation</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * channelname,</div><div class="line">                                  <span class="keyword">const</span> <span class="keywordtype">char</span> * processname,</div><div class="line">                                  <span class="keyword">const</span> <span class="keywordtype">char</span> * systematicname,</div><div class="line">                                  TH1D hist,</div><div class="line">                                  TH1D hist_up,</div><div class="line">                                  TH1D hist_down) ,</div></div><!-- fragment --><p>where <code>channelname</code>, <code>processname</code> and <code>systematicname</code> are the names of the channel, the process and the source of systematic uncertainty. The (<code>TH1D</code>) histograms <code>hist</code>, <code>hist_up</code> and <code>hist_down</code> are the nominal histogram and the histograms corresponding to an “up”- and “down”-scaling of the systematic uncertainty of one standard deviation. In this case, the histograms are not the relative differences but the absolute values. The return value is an error code.</p>
<h1><a class="anchor" id="sec-mtf-runfit"></a>
Running the Fit</h1>
<p>The fit can be started using one of the standard <code><a class="elRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCModel.html">BCModel</a></code> fitting methods, e.g.</p>
<div class="fragment"><div class="line"><a class="codeRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCIntegrate.html#ac84ea45bae755f89e719a08ffa4db57f">BCMTF::MarginalizeAll</a>() ,</div><div class="line"><a class="codeRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCIntegrate.html#aa6f8ede99fe381634878e1c6dd58d364">BCMTF::FindMode</a>() .</div></div><!-- fragment --><h1><a class="anchor" id="sec-mtf-mtfoutput"></a>
Output</h1>
<p>The MTF produces several outputs:</p>
<ol type="1">
<li><code>PrintAllMarginalized(const char* name)</code> prints the marginalized distributions in 1D and 2D for all parameters, i.e., the processes and nuisance parameters into a PostScript file <code>name</code>.</li>
<li><code>PrintResults(const char* name)</code> writes a summary of the fit into a text file <code>name</code>.</li>
<li>To print a stacked histogram of the templates and the data histogram in the file <code>name</code> using a set of parameters <code>parameters</code>, do <div class="fragment"><div class="line">PrintStack(<span class="keywordtype">int</span> channelindex,</div><div class="line">           <span class="keyword">const</span> std::vector&lt;double&gt; &amp; parameters,</div><div class="line">           <span class="keyword">const</span> <span class="keywordtype">char</span> * filename = <span class="stringliteral">&quot;stack.pdf&quot;</span>,</div><div class="line">           <span class="keyword">const</span> <span class="keywordtype">char</span> * options = <span class="stringliteral">&quot;&quot;</span>)</div><div class="line">PrintStack(const <span class="keywordtype">char</span> * channelname,</div><div class="line">           const std::vector&lt;<span class="keywordtype">double</span>&gt; &amp; parameters,</div><div class="line">           const <span class="keywordtype">char</span> * filename = &quot;stack.pdf&quot;,</div><div class="line">           const <span class="keywordtype">char</span> * options = &quot;&quot;)</div></div><!-- fragment --></li>
</ol>
<p>For example, these could be the best fit results. Several options can be specified:</p>
<ul>
<li><code>logx</code>: uses a log-scale for the x-axis.</li>
<li><code>logy</code>: uses a log-scale for the y-axis.</li>
<li><code>logx</code>: plot the x-axis on a log scale</li>
<li><code>logy</code>: plot the y-axis on a log scale</li>
<li><code>bw</code>: plot in black and white</li>
<li><code>sum</code>: draw a line corresponding to the sum of all templates</li>
<li><code>stack</code>: draw the templates as a stack</li>
<li><code>e0</code>: do not draw error bars</li>
<li><code>e1</code>: draw error bars corresponding to sqrt(n)</li>
<li><code>b0</code>: draw an error band on the expectation corresponding to the central 68% probability</li>
<li><code>b1</code>: draw bands showing the probability to observe a certain number of events given the expectation. The green (yellow, red) bands correspond to the central 68% (95%, 99.8%) probability</li>
</ul>
<h1><a class="anchor" id="sec-mtf-mtfsettings"></a>
Settings</h1>
<p>Several settings can be changed which impact the fit.</p>
<ul>
<li><code>SetFlagEfficiencyConstraint</code> sets a flag if the overall efficiency (calculated from the value given when setting a template and the corresponding systematic uncertainties) is constrained to be between 0 and 1 or not. The default value is <code>true</code>.</li>
</ul>
<h1><a class="anchor" id="sec-mtf-facility"></a>
Analysis Facility</h1>
<p>The analysis facility allows to perform a variety of analyses and ensemble tests for a given MTF. It can be created using the constructor:</p>
<div class="fragment"><div class="line"><a class="codeRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCMTFAnalysisFacility.html#a6766e46352e04c6f58cb4b3bd543842c">BCMTFAnalysisFacility::BCMTFAnalysisFacility</a>(<a class="codeRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCMTF.html">BCMTF</a> * mtf)</div></div><!-- fragment --><p>where <code>mtf</code> is the corresponding MTF object.</p>
<h1><a class="anchor" id="sec-mtf-perf_ensemble"></a>
Performing Ensemble Tests</h1>
<p>Ensemble testing is done in two steps: first, ensembles are generated according to the processes defined in the MTF. The ensembles are stored in root files. In a second step, the ensembles are analyzed using the MTF specified.</p>
<h1><a class="anchor" id="sec-mtf-create_ensem"></a>
Creating Ensembles</h1>
<p>Ensembles can be generated using several methods. A single ensemble can be generated using the following method:</p>
<div class="fragment"><div class="line">std::vector&lt;TH1D&gt; <a class="codeRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCMTFAnalysisFacility.html#a0e1730174d54af0f7c0930aebe416835">BCMTFAnalysisFacility::BuildEnsemble</a>(<span class="keyword">const</span> std::vector&lt;double&gt; &amp; parameters)</div></div><!-- fragment --><p>where <code>parameters</code> is a set of parameters which corresponds to those in the template fitter, i.e., the process contributions and nuisance parameters. For most applications, the best fit parameters of the data set at hand is used. The return value is a set of histograms corresponding to a pseudo data set for the different channels.</p>
<p>A similar method is used to generate multiple ensembles:</p>
<div class="fragment"><div class="line">std::vector&lt;TH1D&gt; <a class="codeRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCMTFAnalysisFacility.html#a6289cf313cd4cf8a08ef355a57e15a44">BCMTFAnalysisFacility::BuildEnsembles</a>(<span class="keyword">const</span> std::vector&lt;double&gt; &amp; parameters, <span class="keywordtype">int</span> nensembles)</div></div><!-- fragment --><p>where <code>nensembles</code> is the number of ensembles to be generated. The return value is a pointer to a <code>TTree</code> object in which the ensembles are stored. The entries in the tree are the parameters and the number of entries in each bin of the data histograms.</p>
<p>The third method is based on a tree where the tree contains a set of parameters for each ensemble. This option is preferred if, e.g., the ensembles should be varied accoring to the prior probabilities. The method used to generate ensembles is</p>
<div class="fragment"><div class="line">std::vector&lt;TH1D&gt; <a class="codeRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCMTFAnalysisFacility.html#a6289cf313cd4cf8a08ef355a57e15a44">BCMTFAnalysisFacility::BuildEnsembles</a>(TTree * tree, <span class="keywordtype">int</span> nensembles)</div></div><!-- fragment --><p>where <code>tree</code> is the input tree. Note that the ensembles are randomized, i.e., the first event in the tree does not correspond to the first ensemble. This is done to avoid biases if the tree itself is the output of a Markov Chain.</p>
<h1><a class="anchor" id="sec-mtf-analyze_ensem"></a>
Analyzing Ensembles</h1>
<p>Ensemble tests can be performed usign the ensembles defined earlier or using a set of parameters. In the former case, the method is:</p>
<div class="fragment"><div class="line">TTree * <a class="codeRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCMTFAnalysisFacility.html#a9f9bfa6573e28768f6030efb2d9a7c77">BCMTFAnalysisFacility::PerformEnsembleTest</a>(TTree * tree, <span class="keywordtype">int</span> nensembles)</div></div><!-- fragment --><p>where <code>tree</code> is the tree of ensembles and <code>nensembles</code> is the number of ensembles to be analyzed. The return value is a tree containing the information about the analyzed ensemble. The list of variables is</p>
<ul>
<li><code>parameter_i</code>: the \(i\)th parameter value used at the generation of the ensemble.</li>
<li><code>mode_global_i</code>: the \(i\)th global mode.</li>
<li><code>std_global_i</code>: the \(i\)th standard deviation evaluated with the global mode.</li>
<li><code>chi2_generated_i</code>: the \(\chi^{2}\) calculated using the parameters at generation of the ensemble for channel \(i\).</li>
<li><code>chi2_mode_i</code>: the \(\chi^{2}\) calculated using the global mode parameters for channel \(i\).</li>
<li><code>cash_generated_i</code>: the Cash statistic (Likelihood ratio) calculated using the parameters at generation of the ensemble for channel \(i\).</li>
<li><code>cash_mode_i</code>: the Cash statistic (Likelihood ratio) calculated using the global mode parameters for channel \(i\).</li>
<li><code>n_events_i</code>: the number of events in the ensemble in channel \(i\).</li>
<li><code>chi2_generated_total</code>: the total \(\chi^{2}\) calculated using the parameters at generation of the ensemble.</li>
<li><code>chi2_mode_total</code>: the total \(\chi^{2}\) calculated using the global mode parameters.</li>
<li><code>cash_generated_total</code>: the total Cash statistic calculated using the parameters at generation of the ensemble.</li>
<li><code>cash_mode_total</code>: the total Cash statistic calculated using the global mode parameters.</li>
<li><code>n_events_total</code>: the total number of events in the ensemble.</li>
</ul>
<p>Ensemble tests can also be performed using the following methd:</p>
<div class="fragment"><div class="line">TTree * <a class="codeRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCMTFAnalysisFacility.html#a9f9bfa6573e28768f6030efb2d9a7c77">BCMTFAnalysisFacility::PerformEnsembleTest</a>(<span class="keyword">const</span> std::vector&lt;double&gt; &amp; parameters, <span class="keywordtype">int</span> nensembles)</div></div><!-- fragment --><p>in which case the ensembles are generated internally using the parameters and are then analyzed.</p>
<p>By default the log messages for both the screen and the log-file are suppressed while performing the ensemble test. This can be changed using</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="codeRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCMTFAnalysisFacility.html#af5e268a4bda9832222f5313f054ae8fa">BCMTFAnalysisFacility::SetLogLevel</a>(<a class="codeRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCLog.html#afb5e843091f1d2e61c525c46e1c2f1d9">BCLog::LogLevel</a> level)</div></div><!-- fragment --><h1><a class="anchor" id="sec-mtf-autom_analyses"></a>
Performing Automated Analyses</h1>
<p>The analysis facility also allows to perform an automated analysis over individual channels and or systematic uncertainties.</p>
<h2><a class="anchor" id="sec-mtf-perf_single_channel"></a>
Performing Single-Channel Analyses</h2>
<p>The current data set can be analyzed automatically for each channel separately using the analysis facility method</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="codeRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCMTFAnalysisFacility.html#abf19209aefe0062e4d18d28eceb44995">BCMTFAnalysisFacility::PerformSingleChannelAnalyses</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * dirname, <span class="keyword">const</span> <span class="keywordtype">char</span> * options = <span class="stringliteral">&quot;&quot;</span>)</div></div><!-- fragment --><p>where <code>dirname</code> is the name of a directory which will be created and into which all plots will be copied. If <code>mcmc</code> is specified in the <code>options</code> then the MCMC will be run for each channel. The method creates all marginalized distributions and results as well as an overview plot. If the option <code>nosyst</code> is specified, the systematic uncertainties are all switched off.</p>
<h2><a class="anchor" id="sec-mtf-perf_single_channel_syst"></a>
Performing Single Systematic Analyses</h2>
<p>Similarly, the method</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="codeRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCMTFAnalysisFacility.html#a6939fd1a3a115a135fa32dbb394c9efb">BCMTFAnalysisFacility::PerformSingleSystematicAnalyses</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * dirname, <span class="keyword">const</span> <span class="keywordtype">char</span> * options = <span class="stringliteral">&quot;&quot;</span>)</div></div><!-- fragment --><p>can be used to perform a set of analyses for each systematic uncertainty separately.</p>
<h2><a class="anchor" id="sec-mtf-perf_calib"></a>
Performing Calibration Analyses</h2>
<p>Ensemble tests for different sets of parameters can be automized by using the method</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="codeRef" doxygen="/root/bat/doc/ref-guide/bat-ref.tag:../../ref-guide/html/" href="../../ref-guide/html/classBCMTFAnalysisFacility.html#a609f51eb511251d3f71b5eb6b81146dc">BCMTFAnalysisFacility::PerformCalibrationAnalysis</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * dirname,</div><div class="line">                               <span class="keyword">const</span> std::vector&lt;double&gt; &amp; default_parameters,</div><div class="line">                               <span class="keywordtype">int</span> index,</div><div class="line">                               <span class="keyword">const</span> std::vector&lt;double&gt; &amp; parametervalues,</div><div class="line">                               <span class="keywordtype">int</span> nensembles = 1000)</div></div><!-- fragment --><p>which can be used to easily generate calibration curves. The ensembles are generated for a set of parameters, <code>default_parameters</code> where one of the parameters, <code>index</code>, can vary. The paramter values are defined by <code>parametervalues</code>. <code>nensembles</code> defines the number of pseudo data sets used for each ensemble. </p>
</div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.8-->
<!-- start footer part -->
</div>
</div>
</div>
</div>
</div>
<!-- <hr class="footer"/><address class="footer"><small> -->
<!-- Generated on Tue May 8 2018 13:18:41 for BAT manual by &#160;<a href="http://www.doxygen.org/index.html"> -->
<!-- <img class="footer" src="doxygen.png" alt="doxygen"/> -->
<!-- </a> 1.8.11 -->
<!-- </small></address> -->
</body>
</html>
